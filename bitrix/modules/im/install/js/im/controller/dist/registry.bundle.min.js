this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};(function(e,t,s,a){"use strict";var i=function(){function e(){babelHelpers.classCallCheck(this,e);this.store=null;this.restClient=null;this.templateEngine=null;this.timer=new t.Timer;this._prepareFilesBeforeSave=function(e){return e};this.defaultMessageLimit=20;this.requestMessageLimit=this.getDefaultMessageLimit();this.messageLastReadId={};this.messageReadQueue={}}babelHelpers.createClass(e,[{key:"setTemplateEngine",value:function e(t){this.templateEngine=t}},{key:"setRestClient",value:function e(t){this.restClient=t}},{key:"setStore",value:function e(t){this.store=t}},{key:"getSiteId",value:function e(){return this.store.state.application.common.siteId}},{key:"getUserId",value:function e(){return this.store.state.application.common.userId}},{key:"getLanguageId",value:function e(){return this.store.state.application.common.languageId}},{key:"getCurrentUser",value:function e(){return this.store.getters["users/get"](this.store.state.application.common.userId,true)}},{key:"getChatId",value:function e(){return this.store.state.application.dialog.chatId}},{key:"getDialogId",value:function e(){return this.store.state.application.dialog.dialogId}},{key:"getDialogData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();return this.store.state.dialogues.collection[t]}},{key:"getDialogIdByChatId",value:function e(t){if(this.getDialogId()==="chat"+t){return this.getDialogId()}var s=this.store.getters["dialogues/getByChatId"](t);if(!s){return 0}return s.dialogId}},{key:"getDiskFolderId",value:function e(){return this.store.state.application.dialog.diskFolderId}},{key:"getMessageLimit",value:function e(){return this.store.state.application.dialog.messageLimit}},{key:"getDefaultMessageLimit",value:function e(){return this.defaultMessageLimit}},{key:"getRequestMessageLimit",value:function e(){return this.requestMessageLimit}},{key:"emit",value:function e(t){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.templateEngine.$emit(t,s);return true}},{key:"listen",value:function e(t,s){if(typeof s!=="function"){return false}this.templateEngine.$on(t,s);return true}},{key:"getReadedList",value:function e(){var t=this.store.state.dialogues.collection[this.getDialogId()];if(!t){return[]}return t.readedList}},{key:"isUnreadMessagesLoaded",value:function e(){var t=this.store.state.dialogues.collection[this.getDialogId()];if(!t){return true}if(t.unreadLastId<=0){return true}var s=this.store.state.messages.collection[this.getChatId()];if(!s||s.length<=0){return true}var a=0;for(var i=s.length-1;i>=0;i--){var r=s[i];if(typeof r.id==="number"){a=r.id;break}}return a>=t.unreadLastId}},{key:"prepareFilesBeforeSave",value:function e(t){return this._prepareFilesBeforeSave(t)}},{key:"setPrepareFilesBeforeSaveFunction",value:function e(t){this._prepareFilesBeforeSave=t.bind(this)}},{key:"startOpponentWriting",value:function e(t){var s=this;var a=t.dialogId,i=t.userId,r=t.userName;this.store.dispatch("dialogues/updateWriting",{dialogId:a,userId:i,userName:r,action:true});this.timer.start("writingEnd",a+"|"+i,35,function(e,t){var a=t.dialogId,i=t.userId;s.store.dispatch("dialogues/updateWriting",{dialogId:a,userId:i,action:false})},{dialogId:a,userId:i});return true}},{key:"stopOpponentWriting",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var s=t.dialogId,a=t.userId,i=t.userName;this.timer.stop("writingStart",s+"|"+a,true);this.timer.stop("writingEnd",s+"|"+a);return true}},{key:"startWriting",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();if(a.Utils.dialog.isEmptyDialogId(i)||this.timer.has("writes",i)){return false}this.timer.start("writes",i,28);this.timer.start("writesSend",i,5,function(e){t.restClient.callMethod(s.RestMethod.imDialogWriting,{DIALOG_ID:i}).catch(function(){t.timer.stop("writes",i)})})}},{key:"stopWriting",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();this.timer.stop("writes",t,true);this.timer.stop("writesSend",t,true)}},{key:"setTextareaMessage",value:function e(t){var s=t.message,a=s===void 0?"":s,i=t.dialogId,r=i===void 0?this.getDialogId():i;this.store.dispatch("dialogues/update",{dialogId:r,fields:{textareaMessage:a}})}},{key:"setSendingMessageFlag",value:function e(t){this.store.dispatch("messages/actionStart",{id:t,chatId:this.getChatId()})}},{key:"reactMessage",value:function e(t){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"auto";this.restClient.callMethod(s.RestMethod.imMessageLike,{MESSAGE_ID:t,ACTION:a==="auto"?"auto":a==="set"?"plus":"minus"})}},{key:"readMessage",value:function e(){var t=this;var s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var r=this.getChatId();if(typeof this.messageLastReadId[r]==="undefined"){this.messageLastReadId[r]=null}if(typeof this.messageReadQueue[r]==="undefined"){this.messageReadQueue[r]=[]}if(s){this.messageReadQueue[r].push(parseInt(s))}this.timer.stop("readMessage",r,true);this.timer.stop("readMessageServer",r,true);if(a){return this.readMessageExecute(r,i)}return new Promise(function(e,s){t.timer.start("readMessage",r,.1,function(s,a){return t.readMessageExecute(s,i).then(function(t){return e(t)})})})}},{key:"readMessageExecute",value:function e(t){var a=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return new Promise(function(e,r){if(a.messageReadQueue[t]){a.messageReadQueue[t]=a.messageReadQueue[t].filter(function(e){if(!a.messageLastReadId[t]){a.messageLastReadId[t]=e}else if(a.messageLastReadId[t]<e){a.messageLastReadId[t]=e}})}var n=a.getDialogIdByChatId(t);var u=a.messageLastReadId[t]||0;if(u<=0){e({dialogId:n,lastId:0});return true}a.store.dispatch("messages/readMessages",{chatId:t,readId:u}).then(function(r){a.store.dispatch("dialogues/decreaseCounter",{dialogId:n,count:r.count});if(a.getChatId()===t&&a.store.getters["dialogues/canSaveChat"]){var d=a.store.getters["dialogues/get"](n);if(d.counter<=0){a.store.commit("application/clearDialogExtraCount")}}if(i){e({dialogId:n,lastId:u})}else{a.timer.start("readMessageServer",t,.5,function(){a.restClient.callMethod(s.RestMethod.imDialogRead,{DIALOG_ID:n,MESSAGE_ID:u}).then(function(){return e({dialogId:n,lastId:u})}).catch(function(){return e({dialogId:n,lastId:u})})})}}).catch(function(){e()})})}},{key:"unreadMessage",value:function e(){var t=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var r=this.getChatId();if(typeof this.messageLastReadId[r]==="undefined"){this.messageLastReadId[r]=null}if(typeof this.messageReadQueue[r]==="undefined"){this.messageReadQueue[r]=[]}if(a){this.messageReadQueue[r]=this.messageReadQueue[r].filter(function(e){return e<a})}this.timer.stop("readMessage",r,true);this.timer.stop("readMessageServer",r,true);this.messageLastReadId[r]=a;this.store.dispatch("messages/unreadMessages",{chatId:r,unreadId:this.messageLastReadId[r]}).then(function(e){var n=t.getDialogIdByChatId(r);t.store.dispatch("dialogues/update",{dialogId:n,fields:{unreadId:a}});t.store.dispatch("dialogues/increaseCounter",{dialogId:n,count:e.count});if(!i){t.restClient.callMethod(s.RestMethod.imDialogUnread,{DIALOG_ID:n,MESSAGE_ID:t.messageLastReadId[r]})}}).catch(function(){})}},{key:"shareMessage",value:function e(t,a){this.restClient.callMethod(s.RestMethod.imMessageShare,{DIALOG_ID:this.getDialogId(),MESSAGE_ID:t,TYPE:a});return true}}]);return e}();e.ApplicationController=i})(this.BX.Messenger.Controller=this.BX.Messenger.Controller||{},BX.Messenger,BX.Messenger.Const,BX.Messenger);
//# sourceMappingURL=registry.bundle.map.js